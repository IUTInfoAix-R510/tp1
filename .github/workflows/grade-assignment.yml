name: Grade MongoDB Assignment

on:
  push:
    branches: [ main, master ]
    paths:
      - 'playground-tp1.mongodb.js'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# Permissions required for commit status and PR comments
permissions:
  contents: read
  statuses: write
  pull-requests: write
  issues: write

jobs:
  grade:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .github/scripts
          npm install

      - name: Wait for MongoDB
        run: |
          echo "Waiting for MongoDB to be ready..."
          for i in {1..30}; do
            if mongosh --eval "db.runCommand({ ping: 1 })" > /dev/null 2>&1; then
              echo "MongoDB is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Run grading script
        id: grade
        run: |
          cd .github/scripts
          node grade.js ../../playground-tp1.mongodb.js
        env:
          MONGODB_URI: mongodb://localhost:27017
        continue-on-error: true

      - name: Create grade report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grade-report
          path: .github/scripts/grade-report.json
          if-no-files-found: ignore

      - name: Display grade summary
        if: always()
        run: |
          if [ -f .github/scripts/grade-report.json ]; then
            echo "ðŸ“Š GRADING RESULTS"
            echo "=================="
            cat .github/scripts/grade-report.json | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          print(f\"Total Score: {data.get('totalScore', 'N/A')}/100\")
          print(f\"Structure: {data.get('structure', {}).get('score', 'N/A')}/{data.get('structure', {}).get('maxScore', 10)}\")
          print(f\"Static Analysis: {data.get('static', {}).get('score', 'N/A')}/{data.get('static', {}).get('maxScore', 40)}\")
          print(f\"Tests: {data.get('tests', {}).get('score', 'N/A')}/{data.get('tests', {}).get('maxScore', 50)}\")
          print(f\"Completed Exercises: {data.get('static', {}).get('completedExercises', 'N/A')}/49\")
          for fb in data.get('feedback', []):
              print(f\"  - {fb}\")
          "
          else
            echo "âŒ No grade report found"
          fi

      - name: Comment PR with grade
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');

            let report;
            try {
              report = JSON.parse(fs.readFileSync('.github/scripts/grade-report.json', 'utf8'));
            } catch (e) {
              console.log('Could not read grade report:', e.message);
              return;
            }

            const body = `## ðŸ“Š RÃ©sultat de la notation automatique

            **Note totale : ${report.totalScore}/100**

            ### DÃ©tails

            #### âœ… Structure (${report.structure.score}/${report.structure.maxScore} points)
            ${report.structure.details.map(d => \`- \${d.check}: \${d.passed ? 'âœ…' : 'âŒ'} \${d.message}\`).join('\n')}

            #### ðŸ“ Analyse statique (${report.static.score}/${report.static.maxScore} points)
            - Exercices complÃ©tÃ©s: ${report.static.completedExercises}/49
            - Mots-clÃ©s corrects: ${report.static.correctKeywords}%

            #### ðŸ§ª Tests automatiques (${report.tests.score}/${report.tests.maxScore} points)
            ${report.tests.results ? report.tests.results.map(t => \`- Exercice \${t.number}: \${t.passed ? 'âœ…' : 'âŒ'} \${t.message}\`).join('\n') : 'Tests not executed'}

            ${report.totalScore >= 80 ? 'ðŸŽ‰ Excellent travail !' : report.totalScore >= 60 ? 'ðŸ‘ Bon travail, quelques amÃ©liorations possibles.' : 'âš ï¸ Travail Ã  amÃ©liorer.'}

            ---
            *Cette note est indicative. La note finale sera dÃ©terminÃ©e par l'enseignant.*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Update commit status
        if: always()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');

            let report;
            try {
              report = JSON.parse(fs.readFileSync('.github/scripts/grade-report.json', 'utf8'));
            } catch (e) {
              console.log('Could not read grade report:', e.message);
              return;
            }

            const state = report.totalScore >= 50 ? 'success' : 'failure';
            const description = `Note: ${report.totalScore}/100`;

            try {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.sha,
                state: state,
                description: description,
                context: 'Auto-grading'
              });
            } catch (e) {
              console.log('Could not create commit status:', e.message);
              console.log('This may be due to repository permissions.');
            }
